<!DOCTYPE html>
<html>
<head>
    <title>Content Viewer</title>
    <style>
        body { font-family: Arial; margin: 0; display: flex; }
        .sidebar { width: 200px; background: #f5f5f5; padding: 15px; }
        .main { flex: 1; padding: 15px; }
        .content { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .topics { color: #666; font-size: 0.9em; margin: 5px 0; }
        .meta { font-size: 0.8em; color: #888; }
        button { margin: 2px; padding: 3px 6px; }
        .section { margin-bottom: 15px; }
        #currentTime { background: #f0f0f0; padding: 5px; }
        .stats-panel { position: fixed; top: 0; right: 0; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1); padding: 15px; overflow-y: auto; display: none; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .close-btn { background: #eee; border: none; padding: 3px 8px; cursor: pointer; }
        #userScores { background: #e8f4f8; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 0.85em; }
        .score-item { display: flex; justify-content: space-between; margin: 2px 0; }
        .error { color: #d32f2f; background: #ffebee; padding: 5px; border-radius: 3px; }
        .response { background: #f8f8f8; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; font-size: 0.9em; border: 1px solid #ddd; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="section">
        <h3>Discovery Method</h3>
        <select id="discoveryMethod"><option>TRENDING</option><option>RECOMMENDATION</option><option>SEARCH</option></select>
    </div>
    <div class="section">
        <h3>Time Control</h3>
        <div id="currentTime">Loading...</div>
        <button onclick="advanceTime(0,0,1)">+1m</button>
        <button onclick="advanceTime(0,1,0)">+1h</button>
        <button onclick="advanceTime(1,0,0)">+1d</button>
    </div>
    <div class="section">
        <h3>User Scores</h3>
        <button onclick="fetchUserScores()">Refresh</button>
        <div id="userScores">Click to load...</div>
    </div>
</div>
<div class="main">
    <h1>Contents</h1>
    <div id="contents"></div>
</div>
<div class="stats-panel" id="statsPanel">
    <div class="stats-header">
        <h2>Response</h2>
        <button class="close-btn" onclick="closeStatsPanel()">Ã—</button>
    </div>
    <div id="statsContent"></div>
</div>

<script>
    let userId = "123";

    async function fetchData(url, method='GET', isJson=true) {
        try {
            const res = await fetch(url, {method});
            return isJson ? res.json() : res.text();
        } catch(e) { return null; }
    }

    function displayContents(contents) {
        document.getElementById('contents').innerHTML = (contents||[]).map(c => `
        <div class="content">
            <div>${c.content||'No content'}</div>
            <div class="topics">Topics: ${Array.from(c.topics||[]).join(', ')||'None'}</div>
            <div class="meta">ID: ${c.contentId||'N/A'} | User: ${c.userId||'N/A'} | ${c.timestamp?new Date(c.timestamp).toLocaleString():'No timestamp'}</div>
            <div>${['LIKE','DISLIKE','COMMENT','REPORT'].map(t => `<button onclick="interact('${c.contentId||''}','${t}')">${t}</button>`).join('')}</div>
        </div>`).join('');
    }

    async function interact(contentId, type) {
        if (!contentId) return showResponse('No content ID', true);
        try {
            const method = document.getElementById('discoveryMethod').value;
            const res = await fetch(`http://localhost:8080/content/${contentId}/${type}?discoveryMethod=${method}&userId=${userId}`, {method: 'POST'});
            const text = await res.text();
            let json;
            try { json = JSON.parse(text); } catch(e) {}
            showResponse(json ? JSON.stringify(json, null, 2) : text || 'Empty response', !res.ok);
            if (res.ok) fetchUserScores();
        } catch(e) {
            showResponse('Error: ' + e.message, true);
        }
    }

    function showResponse(content, isError = false) {
        document.getElementById('statsContent').innerHTML = `<div class="${isError ? 'error' : 'response'}">${content}</div>`;
        document.getElementById('statsPanel').style.display = 'block';
    }

    function closeStatsPanel() { document.getElementById('statsPanel').style.display = 'none'; }

    async function fetchUserScores() {
        const scores = await fetchData(`http://localhost:8080/api/userScore/${userId}`);
        document.getElementById('userScores').innerHTML = (scores||[]).sort((a,b) => (b.interestScore||0) - (a.interestScore||0))
            .map(s => `<div class="score-item"><span>${s.topic||'Unknown'}</span><span>${(s.interestScore||0).toFixed(1)}</span></div>`).join('') || 'No scores';
    }

    async function fetchCurrentTime() {
        const time = await fetchData('http://localhost:8080/api/current-time', 'GET', false);
        document.getElementById('currentTime').textContent = time || 'Time unavailable';
    }

    async function advanceTime(d,h,m) {
        const res = await fetchData(`http://localhost:8080/api/advance-time?days=${d}&hours=${h}&minutes=${m}`, 'POST', false);
        alert(res || 'Failed');
        fetchCurrentTime();
    }

    fetchData('http://localhost:8080/content').then(displayContents);
    fetchCurrentTime();
    fetchUserScores();
</script>
</body>
</html>